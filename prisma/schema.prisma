generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                String            @id @default(uuid())
  email             String            @unique
  password          String
  mobile            String?
  pin               String?
  isPinSet          Boolean           @default(false)
  firstName         String?
  lastName          String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  deletedAt         DateTime?
  preferences       Json?
  auditLogs         AuditLog[]
  devices           Device[]
  documents         Document[]
  documentAccess    DocumentAccess[]
  emergencyProfile  EmergencyProfile?
  familyInvitesRecv FamilyInvite[]    @relation("Invitee")
  familyInvites     FamilyInvite[]    @relation("Inviter")
  familyMemberships FamilyMember[]
  notifications     Notification[]
  notificationLogs  NotificationLog[]
  sessions          Session[]
  vaultAccess       VaultAccess[]
  vaultEntries      VaultEntry[]
}

model Session {
  id           String   @id @default(uuid())
  userId       String
  refreshToken String
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Device {
  id          String   @id @default(uuid())
  userId      String
  deviceToken String?
  deviceName  String?
  lastUsed    DateTime @default(now())
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id])
}

model FamilyInvite {
  id        String   @id @default(uuid())
  inviterId String
  email     String
  status    String   @default("PENDING")
  inviteeId String?
  createdAt DateTime @default(now())
  invitee   User?    @relation("Invitee", fields: [inviteeId], references: [id])
  inviter   User     @relation("Inviter", fields: [inviterId], references: [id])
}

model FamilyMember {
  id        String   @id @default(uuid())
  userId    String
  roleId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  role      Role     @relation(fields: [roleId], references: [id])
  user      User     @relation(fields: [userId], references: [id])
}

model Role {
  id            String         @id @default(uuid())
  name          String         @unique
  familyMembers FamilyMember[]
  permissions   Permission[]   @relation("PermissionToRole")
}

model Permission {
  id     String @id @default(uuid())
  action String @unique
  roles  Role[] @relation("PermissionToRole")
}

model VaultCategory {
  id           String       @id @default(uuid())
  name         String       @unique
  icon         String?
  vaultEntries VaultEntry[]
}

model VaultEntry {
  id         String        @id @default(uuid())
  ownerId    String
  categoryId String
  title      String
  metadata   Json?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  deletedAt  DateTime?
  access     VaultAccess[]
  category   VaultCategory @relation(fields: [categoryId], references: [id])
  owner      User          @relation(fields: [ownerId], references: [id])
}

model VaultAccess {
  id           String     @id @default(uuid())
  vaultEntryId String
  userId       String
  canRead      Boolean    @default(true)
  canWrite     Boolean    @default(false)
  createdAt    DateTime   @default(now())
  user         User       @relation(fields: [userId], references: [id])
  vaultEntry   VaultEntry @relation(fields: [vaultEntryId], references: [id])
}

model Document {
  id          String            @id @default(uuid())
  ownerId     String
  title       String
  description String?
  fileKey     String
  fileUrl     String?
  fileType    String
  fileSize    Int
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  deletedAt   DateTime?
  owner       User              @relation(fields: [ownerId], references: [id])
  access      DocumentAccess[]
  versions    DocumentVersion[]
}

model DocumentVersion {
  id         String   @id @default(uuid())
  documentId String
  fileKey    String
  fileUrl    String?
  versionNum Int
  createdAt  DateTime @default(now())
  document   Document @relation(fields: [documentId], references: [id])
}

model DocumentAccess {
  id         String   @id @default(uuid())
  documentId String
  userId     String
  canRead    Boolean  @default(true)
  canUpdate  Boolean  @default(false)
  createdAt  DateTime @default(now())
  document   Document @relation(fields: [documentId], references: [id])
  user       User     @relation(fields: [userId], references: [id])
}

model EmergencyProfile {
  id          String             @id @default(uuid())
  userId      String             @unique
  rules       Json?
  medicalInfo String?
  bloodGroup  String?
  createdAt   DateTime           @default(now())
  contacts    EmergencyContact[]
  user        User               @relation(fields: [userId], references: [id])
}

model EmergencyContact {
  id                 String           @id @default(uuid())
  emergencyProfileId String
  name               String
  email              String
  phone              String
  relation           String
  createdAt          DateTime         @default(now())
  emergencyProfile   EmergencyProfile @relation(fields: [emergencyProfileId], references: [id])
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?
  action    String
  module    String
  requestId String?
  metadata  Json?
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])
}

model Notification {
  id        String    @id @default(uuid())
  userId    String
  title     String
  message   String
  isRead    Boolean   @default(false)
  createdAt DateTime  @default(now())
  readAt    DateTime?
  data      Json?
  type      String    @default("INFO")
  user      User      @relation(fields: [userId], references: [id])
}

model NotificationLog {
  id               String   @id @default(uuid())
  userId           String
  channel          String
  status           String
  providerResponse String?
  error            String?
  createdAt        DateTime @default(now())
  user             User     @relation(fields: [userId], references: [id])
}

model VerificationCode {
  id        String   @id @default(uuid())
  email     String
  code      String
  type      String   // PASSWORD_RESET, EMAIL_VERIFICATION
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@unique([email, type])
}

